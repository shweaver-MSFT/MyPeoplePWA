<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>MyPeople PWA</title>

    <link href="css/global.css" rel="stylesheet">
</head>

<body>
    <div id="contentRoot">
        <div id="headerPanel">
            My People JS - 
            <span id="activationType"></span>
        </div>

        <!-- New or Edit Current Contact Panel -->
        <div id="currentContactPanel">

        </div>

        <!-- Contact Commands Panel -->
        <div id="contactCommandsPanel">
            <div id="contactOptionsPanel">
                <button id="newContactButton">New Contact</button>
            </div>
            <div id="contactSelectionOptionsPanel">
                <button id="pinSelectedButton" disabled>Pin Contact(s)</button>
            </div>
            <div id="contactCollectionOptionsPanel">
                <button id="selectAllButton" disabled>Select All</button>
                <button id="deselectAllButton" disabled>Deselect All</button>
            </div>
        </div>

        <hr />

        <!-- Contact Collection Panel -->
        <div id="contactCollectionPanel">
            <div id="contactCollectionEmptyState">You have no contacts yet. Try creating a new one!</div>
            <div id="contactCollectionContent"></div>
        </div>
    </div>

    <div id="templates" style="display: none;">

        <!-- Contact Details Template (for add/edit contact) -->
        <div id="contactDetailsTemplate">
            <div id="newOrEditIndicator"></div>
            <div id="contentWrapper">
                <div id="contactPicPanel">
                    <img id="contactPic" src="images/Contact.png" />
                </div>
                <div id="contactDetailsPanel">
                    <div id="contactName">
                        <div id="contactFirstName">
                            <input type="text" placeholder="First" />
                        </div>
                        <div id="contactLastName">
                            <input type="text" placeholder="Last" />
                        </div>
                    </div>
                    <div id="contactEmail">
                        <input type="text" placeholder="Email" />
                    </div>
                </div>
            </div>
            <button id="createContactButton">Create Contact</button>
            <button id="updateContactButton" class="hidden">Update Contact</button>
            <button id="pinContactButton" class="hidden">Pin Contact</button>
            <button id="unpinContactButton" class="hidden">Unpin Contact</button>
            <button id="deleteContactButton" class="hidden">Delete Contact</button>
        </div>

        <!-- Contact Template (for contacts collection) -->
        <div id="contactTemplate">
            <div id="contactPicPanel">
                <img id="contactPic" src="images/Contact.png" />
            </div>
            <div id="contactName"></div>
        </div>
    </div>

    <!-- Include scripts at the end, for perf. -->
    <script src="js/logger.js"></script>
    <script src="js/app.js"></script>
    <script src="js/activation.js"></script>
    <script src="js/contacts.js"></script>
    <script src="js/mypeople.js"></script>
    <script>
        (function () {

            /* Main ViewModel */
            viewModel = new function () {

                var contacts = document.contacts;
                var myPeople = document.myPeople;
                var logger = document.logger;

                this.Contacts = [];

                this.InitializeAsync = function () {
                    // Load the contacts
                    return contacts.GetContactsAsync()
                        .then(function (contactList) {
                            contactList.contacts.every((c) => this.Contacts.push(c));
                            return Promise.resolve()
                        }.bind(this));
                }

                this.CreateNewContactAsync = function (first, last, email) {
                    var currentContact;
                    return contacts.CreateContactAsync(first, last, email)
                        .then(function (contact) {
                            currentContact = contact;
                            this.Contacts.push(contact);
                            return myPeople.AnnotateContactAsync(contact);
                        }.bind(this))
                        .then(function (annotation) {
                            logger.Log("New Contact Created and Annotated");
                            return Promise.resolve(currentContact);
                        }.bind(this));
                }.bind(this);

                this.DeleteContactAsync = function (contact) {
                    return contacts.DeleteContactAsync(contact)
                        .then(function () {
                            logger.Log("Contact Deleted");
                            var i = this.Contacts.indexOf(contact);
                            if (i != -1) {
                                this.Contacts.splice(i, 1);
                            }
                            return myPeople.DeleteContactAnnotationsAsync(contact)
                        }.bind(this))
                        .then(function () {
                            logger.Log("Contact Annotations Deleted");
                            return Promise.resolve();
                        }.bind(this));
                }.bind(this);

                this.PinContactAsync = function (contact) {
                    return myPeople.PinContactAsync(contact)
                        .then(function () {
                            logger.Log("Contact Pinned to Taskbar");
                            return Promise.resolve();
                        });
                }.bind(this);

                this.UnpinContactAsync = function (contact) {
                    return myPeople.UnpinContactAsync(contact)
                        .then(function () {
                            logger.Log("Contact Unpinned from Taskbar");
                            return Promise.resolve();
                        });
                }.bind(this);

                this.PinMultipleContactsAsync = function (contacts) {
                    return myPeople.PinMultipleContactsAsync(contacts)
                        .then(function () {
                            logger.Log("Contacts Pinned to Taskbar");
                            return Promise.resolve();
                        });
                }.bind(this);

                this.UpdateContactAsync = function (contact) {
                    return contacts.UpdateContactsAsync(contacts)
                        .then(function () {
                            logger.Log("Contacts Pinned to Taskbar");
                            return Promise.resolve();
                        });
                }.bind(this);

                this.IsContactPinned = function (contact) {
                    return myPeople.IsContactPinned(contact);
                }.bind(this);
            };

            /* Main View */
            var contentRoot = document.querySelector("#contentRoot");
            var templates = document.querySelector("#templates");

            var currentContactPanel = contentRoot.querySelector("#currentContactPanel"); 

            var newContactButton = contentRoot.querySelector("#newContactButton");
            var pinSelectedButton = contentRoot.querySelector("#pinSelectedButton");
            var selectAllButton = contentRoot.querySelector("#selectAllButton");
            var deselectAllButton = contentRoot.querySelector("#deselectAllButton");

            var contactCollectionPanel = contentRoot.querySelector("#contactCollectionPanel");
            var contactCollectionContent = contactCollectionPanel.querySelector("#contactCollectionContent");

            var selectedContacts = [];

            /**
             * 
             * @param contact
             */
            function isContactFocused(contact) {
                var template = contactCollectionContent.querySelector("[data-contact-id='" + contact.id + "']");
                return template.classList.contains("focused");
            }

            /**
             * 
             * @param contact
             * @param isFocused
             */
            function setContactFocused(currentContact) {
                // Update the focus indicator
                for (i = 0; i < viewModel.Contacts.length; i++) {
                    var contact = viewModel.Contacts[i];
                    var template = contactCollectionContent.querySelector("[data-contact-id='" + contact.id + "']");

                    if (currentContact && contact == currentContact) {
                        template.classList.add("focused");
                    }
                    else {
                        template.classList.remove("focused");
                    }
                }
            }

            /**
             * 
             */
            function updateSelectionButtons() {
                selectAllButton.disabled = !(selectedContacts.length < viewModel.Contacts.length);
                deselectAllButton.disabled = !(selectedContacts.length > 0);

                pinSelectedButton.disabled = selectedContacts.length === 0;
            }

            /**
             * 
             */
            function updateCurrentContactButtons(contact) {
                var isPinned = viewModel.IsContactPinned(contact);

                var pinContactButton = currentContactPanel.querySelector("#pinContactButton");
                pinContactButton.disabled = isPinned;

                var unpinContactButton = currentContactPanel.querySelector("#unpinContactButton");
                unpinContactButton.disabled = !isPinned;
            }

            /**
             * 
             * @param contact
             * @param isSelected
             */
            function setContactSelected(contact, isSelected) {

                var template = contactCollectionContent.querySelector("[data-contact-id='" + contact.id + "']");

                if (template) {

                    if (isSelected == false) {
                        var i = selectedContacts.indexOf(contact);
                        if (i != -1) {
                            selectedContacts.splice(i, 1);
                        }

                        template.classList.remove("selected");
                    }
                    else {
                        selectedContacts.push(contact);
                        template.classList.add("selected");
                    }

                    updateSelectionButtons();
                }
            }

            /**
             * 
             * @param e
             */
            function onUpdateContactButtonClick(e) {
                var contact = this.contact;

                viewModel.UpdateContactAsync(contact)
                    .then(function () {

                    });
            }

            /**
             * 
             * @param e
             */
            function onPinContactButtonClick(e) {
                var contact = this.contact;

                viewModel.PinContactAsync(contact)
                    .then(function () {
                        updateCurrentContactButtons(contact);
                    });
            }

            /**
             * 
             * @param e
             */
            function onUnpinContactButtonClick(e) {
                var contact = this.contact;

                viewModel.UnpinContactAsync(contact)
                    .then(function () {
                        updateCurrentContactButtons(contact);
                    });
            }

            /**
             * 
             * @param e
             */
            function onDeleteContactButtonClick(e) {
                var contact = this.contact;

                viewModel.DeleteContactAsync(contact)
                    .then(function () {
                        removeContact(contact);
                        currentContactPanel.innerHTML = "";
                        updateSelectionButtons();
                    });
            }

            /**
             * 
             * @param contact
             */
            function updateCurrentContact(contact) {
                // Contact bound during onCreateContactButtonClick
                var currentContact = contact;

                // Clear out the currentContact
                currentContactPanel.innerHTML = "";

                // Clone the template so we don't affect the original one
                var contactDetailsTemplate = templates.querySelector("#contactDetailsTemplate").cloneNode(true);

                // Update the template values
                var newOrEditIndicator = contactDetailsTemplate.querySelector("#newOrEditIndicator");
                newOrEditIndicator.textContent = "*EDIT";

                contactDetailsTemplate.querySelector("#contactFirstName input").value = currentContact.firstName;
                contactDetailsTemplate.querySelector("#contactLastName input").value = currentContact.lastName;
                contactDetailsTemplate.querySelector("#contactEmail input").value = currentContact.remoteId;

                // Wire up the Update Contact button
                contactDetailsTemplate.querySelector("#createContactButton").classList.add("hidden");

                var updateContactButton = contactDetailsTemplate.querySelector("#updateContactButton");
                updateContactButton.classList.remove("hidden");
                updateContactButton.onclick = onUpdateContactButtonClick.bind({ "contact": currentContact });;

                // Wire up additional edit buttons
                var isPinned = viewModel.IsContactPinned(currentContact);

                var pinContactButton = contactDetailsTemplate.querySelector("#pinContactButton");
                pinContactButton.classList.remove("hidden");
                pinContactButton.disabled = isPinned;
                pinContactButton.onclick = onPinContactButtonClick.bind({ 'contact': currentContact });

                var unpinContactButton = contactDetailsTemplate.querySelector("#unpinContactButton");
                unpinContactButton.classList.remove("hidden");
                unpinContactButton.disabled = !isPinned;
                unpinContactButton.onclick = onUnpinContactButtonClick.bind({ 'contact': currentContact });

                var deleteContactButton = contactDetailsTemplate.querySelector("#deleteContactButton");
                deleteContactButton.classList.remove("hidden");
                deleteContactButton.onclick = onDeleteContactButtonClick.bind({ 'contact': currentContact });

                // Add the updated template to the currentContactPanel
                currentContactPanel.appendChild(contactDetailsTemplate);
            }

            /**
             * 
             * @param contact
             */
            function addContact(contact) {
                // Add the new contact to the UI
                var contactTemplate = templates.querySelector("#contactTemplate").cloneNode(true);

                // Update the template values
                var contactName = contactTemplate.querySelector("#contactName");
                contactName.innerHTML = contact.displayName;

                contactTemplate.setAttribute("data-contact-id", contact.id);

                // Wire up selection interaction
                // Bind the contact to the function for easy retrieval
                contactTemplate.onclick = onContactClick.bind({ "contact": contact });

                // Add the template to the UI
                contactCollectionContent.appendChild(contactTemplate);

                // Hide the empty state
                contactCollectionEmptyState.classList.add("hidden");
            }

            /**
             * 
             * @param contact
             */
            function removeContact(contact) {
                var template = contactCollectionContent.querySelector("[data-contact-id='" + contact.id + "']");
                template.remove();
            }

            /**
             * 
             * @param e
             */
            function onContactClick(e) {

                // Contact bound during onCreateContactButtonClick
                var currentContact = this.contact;

                updateCurrentContact(currentContact);

                if (!isContactFocused(currentContact)) {
                    setContactFocused(currentContact);
                }
                else {
                    setContactSelected(currentContact, selectedContacts.indexOf(currentContact) === -1);
                }
            }

            /**
             * 
             * @param e
             */
            function onCreateContactButtonClick(e) {

                var first = currentContactPanel.querySelector("#contactFirstName input");
                var last = currentContactPanel.querySelector("#contactLastName input");
                var email = currentContactPanel.querySelector("#contactEmail input");

                var isError = false;
                if (first.value.trim() === "" || last.value.trim() === "" || email.value.trim() === "") {

                    function updateBorderColor(input) {
                        if (input.value.trim() === "") {
                            input.classList.add("error");
                            isError = true;
                        }
                        else {
                            input.classList.remove("error");
                        }
                    }

                    updateBorderColor(first);
                    updateBorderColor(last);
                    updateBorderColor(email);
                }

                // Validate the email a bit. This helps ensure that when creating new contacts they have a usable email to test sharing with.
                var re = new RegExp("[a - z0 - 9!#$ %& '*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&' * +/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?");
                if (re.test(email.value.toLowerCase())) {
                    email.classList.add("error");
                    isError = true;
                }
                else {
                    email.classList.remove("error");
                }

                if (isError) return;

                // Create the new contact
                viewModel.CreateNewContactAsync(first.value, last.value, email.value)
                    .then(function (contact) {
                        addContact(contact);
                        updateCurrentContact(contact);
                        setContactSelected(contact, false);
                        setContactFocused(contact);
                    });
            }

            /**
             * 
             */
            newContactButton.addEventListener("click", function (e) {

                // Clear out the currentContact
                currentContactPanel.innerHTML = "";

                // Clone the template so we don't affect the original one
                var contactDetailsTemplate = templates.querySelector("#contactDetailsTemplate").cloneNode(true);

                // Update the template values
                var newOrEditIndicator = contactDetailsTemplate.querySelector("#newOrEditIndicator");
                newOrEditIndicator.textContent = "*NEW";

                // Wire up the createContact button
                var createContactButton = contactDetailsTemplate.querySelector("#createContactButton");
                createContactButton.onclick = onCreateContactButtonClick;

                // Add the updated template to the currentContactPanel
                currentContactPanel.appendChild(contactDetailsTemplate);

                setContactFocused(null);
            });

            /**
             * 
             */
            pinSelectedButton.addEventListener("click", function (e) {
                var contacts = selectedContacts;

                viewModel.PinMultipleContactsAsync(contacts)
                    .then(function () {

                    });
            });

            /**
             * Select all of the deselected contacts
             */
            selectAllButton.addEventListener("click", function (e) {

                for (i = 0; i < viewModel.Contacts.length; i++) {
                    var contact = viewModel.Contacts[i];

                    if (selectedContacts.indexOf(contact) === -1) {
                        setContactSelected(contact, true);
                    }
                }
            });

            /**
             * Deselect all of the selected contacts
             */
            deselectAllButton.addEventListener("click", function (e) {

                for (i = 0; i < selectedContacts.length; i++) {
                    var contact = selectedContacts[i];

                    if (selectedContacts.indexOf(contact) >= 0) {
                        setContactSelected(contact, false);
                        i--;
                    }
                }
            });

            // Init the VM
            viewModel.InitializeAsync()
                .then(function () {
                    for (i = 0; i < viewModel.Contacts.length; i++) {
                        var contact = viewModel.Contacts[i];
                        addContact(contact);
                    }

                    updateSelectionButtons();
                });
        })();
    </script>
</body>
</html>
